# Load Data and Dependencies ----------------------------------------------

library(dplyr) # for data manipulation
library(ggplot2) # for visualizations
library(lme4) # for multilevel models
library(lmerTest) # for p-values
library(performance) # for intraclass correlation

data <- read.csv('heck2011 copy.csv', fileEncoding = "UTF-8-BOM")

# Why Multilevel Models? --------------------------------------------------

data_sub <- data %>% 
  filter(schcode <= 10)

data_sub %>% 
  ggplot(mapping = aes(x = ses, y = math)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE)

data_sub %>% 
  ggplot(mapping = aes(x = ses, y = math, colour = factor(schcode))) +
  geom_point() +
  geom_smooth(mapping = aes(group = schcode), method = "lm", se = FALSE, fullrange = TRUE) +
  labs(colour = "schcode")

# The Null Model ----------------------------------------------------------

null_model <- lmer(math ~ 1 + (1|schcode), data = data)
summary(null_model)

# Degrees of freedom correspond to number of parameters estimated 
logLik(null_model)

# Understanding Variance --------------------------------------------------

# Intraclass Correlation Coefficient ICC
#The more extensive the impact of clustering, the more variance between clusters 

performance::icc(null_model)

Tau0 <- VarCorr(null_model)$schcode[1]

# Plausible Value Ranges tot understand variance 
lower_bound <- null_model@beta - 1.96*sqrt(Tau0)
upper_bound <- null_model@beta + 1.96*sqrt(Tau0)

lower_bound
upper_bound


#This range gives us a sense of the variance in school intercepts: 95% of intercepts will fall between 51 and 64. 13 points of variance is a fair amount for a scale from 0 to 100! It seems good that weâ€™re accounting for that variance with our multilevel model, rather than treating all schools like they have the same intercept.

# Empirical Bayes Estimates -----------------------------------------------
#Random effects of the intercepts are latent variables rather than statistical parameters, but we can estimate them to visualize how much they vary and estimate a weighed intercept for a given group

data %>% 
  filter(schcode == 1) %>% # select only school code 1
  summarize(
    mean(math)
  )

data %>% 
  filter(schcode == 1) %>% 
  count()

empirical_bayes_data <- as_tibble(ranef(null_model))

head(empirical_bayes_data, 1)

ggplot(data = empirical_bayes_data, mapping = aes(x = condval)) + # "condval" is the name of the EB estimates returned by the ranef function above 
  geom_histogram() +
  labs(x = "EB estimate of U0j")

