# Load Data and Dependencies ----------------------------------------------

library(dplyr) # for data manipulation
library(magrittr) # for assignment pipe %<>%
library(lme4) # for multilevel models
library(lmerTest) # for p-values

data <- read.csv('heck2011 copy 5.csv', fileEncoding = "UTF-8-BOM")

# Options for Centering in MLMs -------------------------------------------
#Centering in regression facilitates interpretation of the intercept, which is the average value of your outcome variable when all predictors are set to zero. If your predictors do not have meaningful zero points, then the intercept can be non-sensical.

model <- lmer(math ~ 1 + ses + (1|schcode), data = data, REML = TRUE)
summary(model)

# Centering Within Cluster (CWC) ------------------------------------------

#Centering a variable within a cluster means each cluster will have a mean of zero. So, each school will have a mean of zero, and students’ scores on ses_cwc will reflect their variance around their school mean, not the grand mean of the whole dataset.

data %<>% # this symbol is an assignment operator and pipe, equivalent to data <- data %>% 
  group_by(schcode) %>% 
  mutate(ses_mean = mean(ses))

data %<>%
  mutate(ses_cwc = ses - ses_mean)

data %>% 
  group_by(schcode) %>% 
  summarize(
    mean(ses_cwc)
  )

model_cwc <- lmer(math ~ 1 + ses_cwc + (1|schcode), data = data, REML = TRUE)
summary(model_cwc)

model_cwc_l2 <- lmer(math ~ 1 + ses_cwc + ses_mean + (1|schcode), data = data, REML = TRUE)
summary(model_cwc_l2)

# Centering Grand Mean (CGM) ----------------------------------------------

# center a variable at the grand mean, we have information about how individuals vary around the mean of all individuals. So students’ scores on ses_cgm will reflect their variance around the mean of all students.

data %<>%
  ungroup() %>% # remove the grouping by school that we added in the CWC section
  mutate(ses_grand_mean = mean(ses))

data %<>%
  mutate(ses_cgm = ses - ses_grand_mean)

data %>% 
  summarize(
    mean(ses_cgm)
  )

cgm_model <- lmer(math ~ 1 + ses_cgm + ses_mean + (1|schcode), data = data, REML = TRUE)
summary(cgm_model)

